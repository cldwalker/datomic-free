#!/usr/bin/env bash
set -e

DATOMIC_FREE_HOME=$HOME/.datomic-free
DATOMIC_FREE=$DATOMIC_FREE_HOME/datomic-free-latest

get-latest-datomic-version () {
  curl -s http://downloads.datomic.com/free.html | grep -o 'datomic-free.*latest' |
    sed 's/datomic-free-\(.*\)\.zip.*$/\1/g'
}

# mostly from https://github.com/relevance/diametric/blob/master/script/vendor-datomic-free
download-and-link-datomic () {
  DEFAULT_DATOMIC_VERSION="0.8.3599"
  VERSION=${1:-$DEFAULT_DATOMIC_VERSION}

  if [ ! -d "$DATOMIC_FREE_HOME/datomic-free-$VERSION" ]; then
    echo "Downloading Datomic Free $VERSION"

    cd $DATOMIC_FREE_HOME
    curl --progress-bar -o datomic-free.zip "http://downloads.datomic.com/$VERSION/datomic-free-$VERSION.zip"
    unzip datomic-free.zip > /dev/null
    rm datomic-free.zip

    rm -f $DATOMIC_FREE
    ln -s "$DATOMIC_FREE_HOME/datomic-free-$VERSION" $DATOMIC_FREE
    echo "Done. Datomic Free $VERSION is now available"

  else
    echo "Datomic Free $VERSION is already present"
  fi

}

command="$1"
case "$command" in
"" | "-h" | "--help")
  echo "datomic-free [-h|--help] [start|update]"
  ;;
"start")
  cd $DATOMIC_FREE
  bin/transactor config/samples/free-transactor-template.properties
  ;;
"update")
  echo "Fetching latest datomic version..."
  version=$(get-latest-datomic-version)

  if [ "$version" = "" ]; then
    echo "The latest version could not be fetched."
  else
    download-and-link-datomic $version
  fi
  ;;
esac
